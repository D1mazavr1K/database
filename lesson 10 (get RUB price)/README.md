## Конвертация валют 
Допустим мы хотим посчитать среднею цену на некий продукт  `product_id = 1` в валюте `currency_id = 3`
, тогда запрос будет выглядеть следующим образом

```sql
select avg(
    case
        when pp.cur_id = 3 then pp.value
        else pp.value * (select c.value 
                      from course c 
                      where c.cur_id_from = pp.cur_id 
                        and c.cur_id_to = 3 
                      order by date_to DESC 
                      limit 1)
    end
    )
from product_price pp
where product_id = 1
```
1. В агрегатную функцию необходимо встроить условную конструкцию (в контексте postgresql -  `case`)
2. Если цена продукта уже указана в нужной нам валюте, возвращаем в `CASE` цену продукта, иначе считаем цену в нужной валюте при помощи подзапроса,
в котором получаем множитель для перевода некой валюты в нужную нам. (очевидно что, для того чтобы это работало для вашей валюты
должны быть заполнены курсы для перевода любой валюты в вашу)

P.S: в приведенном примере в подзапросе для конвертации используются последние имеющиеся курсы, но в вашем запросе, возможно, понадобятся старые значение.

Пример: вывести сумму покупок всех продуктов за 2020 год, `цену вывести в рублях, используя курсы, актуальные на момент конкретной закупки`

Тогда в условии для выбора курса будет что-то вроде этого:  `outgoing.date between course.date_from and course.date_to`
(естественно если вам достался подобный запрос, то в таблицу курсов нужно добавить значения курсов для нужных вам дат)



P.S 2: вообще-то указывать нужную валюту через атрибут `cur_id` не очень красиво,
лучше делать это через атрибут `currency.short_name`
Для этого нужно просто сделать `join` таблицы `currency` и в условии CASE конструкции указывать `currency.short_name = 'USD'` вместо `product_price.cur_id = 3` 
